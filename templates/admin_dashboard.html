{% extends "base.html" %}

{% block title %}ููุญุฉ ุงูุฅุฏุงุฑุฉ{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <h2>๐๏ธ ููุญุฉ ุงูุฅุฏุงุฑุฉ</h2>
    
    <div class="admin-tabs">
        <button class="tab-btn active" onclick="showTab('products')">๐ฆ ุงููุฎุฒูู</button>
        <button class="tab-btn" onclick="showTab('offers')">๐ฅ ุฅุฏุงุฑุฉ ุงูุนุฑูุถ</button>
        <button class="tab-btn" onclick="showTab('orders')">๐ ุงููุจูุนุงุช</button>
    </div>

    <!-- Products Tab -->
    <div id="products-tab" class="tab-content active">
        <h3>๐ฆ ููุญุฉ ุงููุฎุฒูู</h3>
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ุงูุงุณู</th>
                        <th>ุงูุณุนุฑ</th>
                        <th>ุงููุฎุฒูู</th>
                        <th>ุชูุงุตูู ุงูุนุฑูุถ</th>
                        <th>ุงูุฅุฌุฑุงุกุงุช</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr>
                        <td>{{ product.id }}</td>
                        <td>{{ product.name }}</td>
                        <td>{{ product.price }}$</td>
                        <td>{{ product.stock }}</td>
                        <td>
                            {% if product.offer_discount > 0 %}
                                <span class="badge badge-success">ุฎุตู {{ product.offer_discount }}%</span>
                            {% endif %}
                            {% if product.offer_gift %}
                                <span class="badge badge-info">๐ {{ product.offer_gift }}</span>
                            {% endif %}
                            {% if product.offer_limit > 0 %}
                                <span class="badge badge-warning">ุญุฏ: {{ product.offer_limit }}</span>
                            {% endif %}
                            {% if not product.offer_discount and not product.offer_gift %}
                                <span class="text-muted">---</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editProduct({{ product.id }}, '{{ product.name }}', {{ product.price }}, {{ product.stock }})">
                                ุชุนุฏูู
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Offers Tab -->
    <div id="offers-tab" class="tab-content">
        <h3>๐ฅ ุฅุฏุงุฑุฉ ุงูุนุฑูุถ</h3>
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ุงูุงุณู</th>
                        <th>ุงูุณุนุฑ</th>
                        <th>ุงููุฎุฒูู</th>
                        <th>ุงูุนุฑูุถ ุงูุญุงููุฉ</th>
                        <th>ุงูุฅุฌุฑุงุกุงุช</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr>
                        <td>{{ product.id }}</td>
                        <td>{{ product.name }}</td>
                        <td>{{ product.price }}$</td>
                        <td>{{ product.stock }}</td>
                        <td>
                            {% if product.offer_discount > 0 %}
                                <span class="badge badge-success">ุฎุตู {{ product.offer_discount }}%</span>
                            {% endif %}
                            {% if product.offer_gift %}
                                <span class="badge badge-info">๐ {{ product.offer_gift }}</span>
                            {% endif %}
                            {% if product.offer_limit > 0 %}
                                <span class="badge badge-warning">ุญุฏ: {{ product.offer_limit }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="applyOffer({{ product.id }}, {{ product.offer_discount }}, '{{ product.offer_gift or "" }}', {{ product.offer_limit }})">
                                ุฅุฏุงุฑุฉ ุงูุนุฑุถ
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Orders Tab -->
    <div id="orders-tab" class="tab-content">
        <h3>๐ ุงููุจูุนุงุช</h3>
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ุฑูู ุงูุทูุจ</th>
                        <th>ุงูุนููู</th>
                        <th>ุงููุจูุบ</th>
                        <th>ุทุฑููุฉ ุงูุฏูุน</th>
                        <th>ุงูุญุงูุฉ</th>
                        <th>ุงูุชุงุฑูุฎ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr>
                        <td>#{{ order.order_id }}</td>
                        <td>{{ order.customer_name }}</td>
                        <td>{{ order.total }}$</td>
                        <td>{{ order.pay_method }}</td>
                        <td>
                            <span class="badge badge-{{ 'success' if order.pay_status == 'Paid' else 'warning' }}">
                                {{ order.pay_status }}
                            </span>
                        </td>
                        <td>{{ order.date }}</td>
                    </tr>
                    {% endfor %}
                    {% if not orders %}
                    <tr>
                        <td colspan="6" class="text-center">ูุง ุชูุฌุฏ ุทูุจุงุช ุจุนุฏ</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('editModal')">&times;</span>
        <h3>ุชุนุฏูู ุงูููุชุฌ</h3>
        <form id="editProductForm">
            <input type="hidden" id="edit_product_id" name="product_id">
            <div class="form-group">
                <label>ุงูุงุณู:</label>
                <input type="text" id="edit_product_name" name="name" class="form-control">
            </div>
            <div class="form-group">
                <label>ุงูุณุนุฑ:</label>
                <input type="number" id="edit_product_price" name="price" step="0.01" class="form-control">
            </div>
            <div class="form-group">
                <label>ุงููุฎุฒูู:</label>
                <input type="number" id="edit_product_stock" name="stock" class="form-control">
            </div>
            <button type="submit" class="btn btn-primary">ุญูุธ</button>
        </form>
    </div>
</div>

<!-- Apply Offer Modal -->
<div id="offerModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('offerModal')">&times;</span>
        <h3>ุฅุฏุงุฑุฉ ุงูุนุฑุถ</h3>
        <form id="offerForm">
            <input type="hidden" id="offer_product_id" name="product_id">
            <div class="form-group">
                <label>ูุณุจุฉ ุงูุฎุตู (%):</label>
                <input type="number" id="offer_discount" name="discount" step="0.1" min="0" max="100" class="form-control" placeholder="0 = ุจุฏูู ุฎุตู">
            </div>
            <div class="form-group">
                <label>ุงุณู ุงููุฏูุฉ:</label>
                <input type="text" id="offer_gift" name="gift" class="form-control" placeholder="ุงุชุฑูู ูุงุฑุบุงู ูุฅูุบุงุก ุงููุฏูุฉ">
            </div>
            <div class="form-group">
                <label>ุงูุญุฏ ุงูุฃูุตู ููุนููู:</label>
                <input type="number" id="offer_limit" name="limit" min="0" class="form-control" placeholder="0 = ุจุฏูู ุญุฏ">
                <small class="text-muted">ุงูุญุฏ ุงูุฃูุตู ูุนุฏุฏ ุงููุทุน ุงูุชู ูููู ููุนููู ุดุฑุงุคูุง</small>
            </div>
            <button type="submit" class="btn btn-success">ุชุทุจูู</button>
            <button type="button" class="btn btn-danger" onclick="removeOffer()">ุญุฐู ุงูุนุฑุถ</button>
        </form>
    </div>
</div>

<script>
function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    
    document.getElementById(tabName + '-tab').classList.add('active');
    event.target.classList.add('active');
}

function editProduct(id, name, price, stock) {
    document.getElementById('edit_product_id').value = id;
    document.getElementById('edit_product_name').value = name;
    document.getElementById('edit_product_price').value = price;
    document.getElementById('edit_product_stock').value = stock;
    document.getElementById('editModal').style.display = 'block';
}

function applyOffer(id, discount, gift, limit) {
    document.getElementById('offer_product_id').value = id;
    document.getElementById('offer_discount').value = discount || 0;
    document.getElementById('offer_gift').value = gift || '';
    document.getElementById('offer_limit').value = limit || 0;
    document.getElementById('offerModal').style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function removeOffer() {
    document.getElementById('offer_discount').value = 0;
    document.getElementById('offer_gift').value = '';
    document.getElementById('offer_limit').value = 0;
    document.getElementById('offerForm').submit();
}

document.getElementById('editProductForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const response = await fetch('/admin/edit_product', {
        method: 'POST',
        body: formData
    });
    const data = await response.json();
    if (data.success) {
        alert('ุชู ุงูุชุนุฏูู ุจูุฌุงุญ');
        location.reload();
    } else {
        alert('ุญุฏุซ ุฎุทุฃ');
    }
});

document.getElementById('offerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const response = await fetch('/admin/apply_offer', {
        method: 'POST',
        body: formData
    });
    const data = await response.json();
    if (data.success) {
        alert('ุชู ุชุทุจูู ุงูุนุฑุถ ุจูุฌุงุญ');
        location.reload();
    } else {
        alert('ุญุฏุซ ุฎุทุฃ');
    }
});

window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    });
}
</script>
{% endblock %}

